# 調査レポート: Shareholder Portal Login機能実装

## 調査日時
- 日付: 2026年2月9日
- ブランチ: feature/shareholder-login

## 1. 調査概要

### 背景
株主総会支援システム「Kuroko Realtime」において、株主向けポータルへの認証機能を実装する必要がある。提供されたUIデザインとFirebase設定を基に、既存のBiDiデモアプリケーションにログイン機能を追加する。

### 調査スコープ
- Shareholder Portal Loginのサインイン機能実装
- Firebase Authentication統合
- Voice Interaction Login対応の検討
- 既存システム（ADK BiDi-streaming）との統合

## 2. 現状分析

### 2.1 既存アーキテクチャ

#### バックエンド
- **フレームワーク**: FastAPI (Python)
- **リアルタイム通信**: WebSocket
- **AI機能**: Google ADK (Agent Development Kit)
- **セッション管理**: InMemorySessionService

#### フロントエンド
- **技術**: Vanilla JavaScript（フレームワークなし）
- **スタイル**: Pure CSS
- **通信**: WebSocket API

#### 現在の問題点
1. 認証システムが存在しない
2. WebSocketエンドポイントが公開アクセス可能
3. ユーザーIDがハードコード（"demo-user"）
4. セキュリティ機能の欠如

### 2.2 デザイン要件（提供されたUI）

- **タイトル**: "Shareholder Portal"
- **サブタイトル**: "Voice Interaction Login"
- **入力フィールド**:
  - Email（プレースホルダー: "Enter your email"）
  - Password（プレースホルダー: "Enter your password"）
- **機能ボタン**:
  - Loginボタン（紫色、#6B46C1）
  - "Forgot Password?"リンク
- **デザイン**: カードベースのUI、グラデーション背景

### 2.3 Firebase設定（提供済み）

```javascript
const firebaseConfig = {
  apiKey: "AIzaSyDN8QXO_Aw57r-xHzT_mzCV8JVCwLBiNcM",
  authDomain: "dsk-agentspace-trial.firebaseapp.com",
  projectId: "dsk-agentspace-trial",
  storageBucket: "dsk-agentspace-trial.firebasestorage.app",
  messagingSenderId: "886325466422",
  appId: "1:886325466422:web:e8abcab15947dd62b98f97"
};
```

## 3. 技術的制約と可能性

### 3.1 Firebase Authentication統合

#### 実装可能な機能
- メール/パスワード認証
- パスワードリセット機能
- JWT トークンベースの認証
- セッション永続化
- ユーザープロファイル管理

#### 統合方法
1. **フロントエンド**: Firebase JS SDKを使用
2. **バックエンド**: Firebase Admin SDKでトークン検証
3. **WebSocket認証**: JWTトークンをクエリパラメータで送信

### 3.2 Voice Interaction統合可能性

#### 現在のADK機能との統合
- 既存のWebSocket音声ストリーミング機能を活用
- 音声認証（Voice ID）の将来的な実装
- リアルタイム音声コマンドによるログイン

#### 実装段階
1. **Phase 1**: 基本的なメール/パスワード認証
2. **Phase 2**: 音声によるパスワード入力
3. **Phase 3**: 音声認証（Voice Biometrics）

## 4. 実装方針

### 4.1 ファイル構成

```
app/
├── static/
│   ├── login.html        # ログインページ（新規）
│   ├── js/
│   │   ├── firebase-auth.js  # Firebase認証モジュール（新規）
│   │   └── login.js          # ログインUI処理（新規）
│   └── css/
│       └── login.css         # ログインスタイル（新規）
├── auth/
│   └── __init__.py          # 認証ミドルウェア（新規）
└── main.py                  # 既存（認証追加）
```

### 4.2 実装ステップ

#### Step 1: フロントエンド開発
1. ログインページ（login.html）の作成
2. Firebase SDKの統合
3. ログインUIのスタイリング
4. 認証フローの実装

#### Step 2: バックエンド開発
1. Firebase Admin SDK統合
2. JWT検証ミドルウェア
3. WebSocketエンドポイントの保護
4. ユーザーセッション管理

#### Step 3: 統合テスト
1. エンドツーエンド認証フロー
2. セッション永続性
3. エラーハンドリング
4. セキュリティ検証

### 4.3 セキュリティ考慮事項

1. **トークン管理**: セキュアなトークン保存（sessionStorage推奨）
2. **HTTPS必須**: プロダクション環境でのSSL/TLS
3. **レート制限**: ログイン試行回数の制限
4. **CORS設定**: 適切なオリジン制限
5. **入力検証**: XSS/SQLインジェクション対策

## 5. リスクと軽減策

### 技術的リスク
| リスク | 影響度 | 軽減策 |
|--------|--------|--------|
| Firebase SDK互換性 | 中 | バージョン固定、テスト強化 |
| WebSocket認証複雑性 | 高 | 段階的実装、フォールバック機能 |
| 既存機能への影響 | 中 | 機能フラグ、段階的ロールアウト |

### セキュリティリスク
| リスク | 影響度 | 軽減策 |
|--------|--------|--------|
| 認証バイパス | 高 | 多層防御、定期監査 |
| トークン漏洩 | 高 | 短期トークン、リフレッシュ機能 |
| セッションハイジャック | 中 | HTTPS強制、セッション検証 |

## 6. 推奨事項

### 即座に実装すべき機能
1. 基本的なメール/パスワード認証
2. ログインUIの実装
3. WebSocketエンドポイントの保護
4. パスワードリセット機能

### 将来的な拡張
1. Voice Interaction Login
2. 多要素認証（MFA）
3. ソーシャルログイン
4. 役割ベースのアクセス制御（RBAC）

## 7. 次のステップ（PLAN フェーズ）

### 推奨アクション
1. **実装計画書の作成**: 詳細なタスク分解と工数見積もり
2. **プロトタイプ開発**: ログインUIの動作確認
3. **Firebase プロジェクト設定**: 認証方法の有効化
4. **テスト計画策定**: ユニットテスト、統合テスト

### 成功基準
- ユーザーがメール/パスワードでログイン可能
- 認証済みユーザーのみWebSocket接続可能
- セッション永続性の確保
- エラーハンドリングの適切な実装

## 8. 結論

Shareholder Portal Login機能の実装は技術的に実現可能であり、既存システムとの統合も問題なく行える。Firebase Authenticationを活用することで、セキュアで拡張性のある認証システムを構築できる。Voice Interaction機能は将来的な拡張として段階的に実装することを推奨する。

---
調査完了: 2026年2月9日
ブランチ: feature/shareholder-login
次フェーズ: PLAN（実装計画策定）